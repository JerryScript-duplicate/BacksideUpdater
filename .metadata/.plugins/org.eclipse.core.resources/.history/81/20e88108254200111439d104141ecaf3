package com.Backside.BacksideUpdater;

import java.io.BufferedReader;
import java.io.InputStreamReader;

import org.apache.http.HttpResponse;
import org.apache.http.client.HttpClient;
import org.apache.http.client.methods.HttpGet;
import org.apache.http.impl.client.DefaultHttpClient;

import android.app.Activity;
import android.os.Bundle;
import android.os.Build;
import android.content.*;
import android.net.Uri;
import android.view.View;
import android.widget.TextView;
import android.widget.Button;

public class BacksideUpdaterActivity extends Activity {
	private String updateManifestUrl = "https://raw.github.com/JerryScript/BACKside-IHO/master/README";
	private TextView textView;
	private TextView buttonTextView;
	private Button theButton;
	private static final String BUILD_VERSION = Build.VERSION.INCREMENTAL;
	private static final String[] SEPARATED_DATE = BUILD_VERSION.split("\\.");
	private static final int BUILD_DATE = Integer.parseInt(SEPARATED_DATE[2]);
	private boolean ALREADY_CHECKED = false;
	private String theDate;
	private String theUrl;

	
/** Called when the activity is first created. */


	@Override
	public void onCreate(Bundle savedInstanceState) {
		super.onCreate(savedInstanceState);
		setContentView(R.layout.main);

		textView = (TextView) findViewById(R.id.pagetext);
		textView.setText("Click to check for the lastest update");
		
		buttonTextView = (TextView) findViewById(R.id.BacksideUpdaterButton);
		theButton = (Button) findViewById(R.id.BacksideUpdaterButton);

	}

	
	public void myClickHandler(View view) {
		switch (view.getId()) {
		case R.id.BacksideUpdaterButton:
			try {
				if (!ALREADY_CHECKED) {
					ALREADY_CHECKED = true;
					textView.setText("");
					HttpClient client = new DefaultHttpClient();
					HttpGet request = new HttpGet(updateManifestUrl);
					HttpResponse response = client.execute(request);
					// Get the response
					BufferedReader rd = new BufferedReader(new InputStreamReader(
							response.getEntity().getContent()));
					String line = rd.readLine();
					String[] separated = line.split(",");
					theDate = separated[0];
					theUrl = separated[1];
					if (Integer.parseInt(separated[0]) <  BUILD_DATE) {
						textView.setText("A new build is available:\nBACKside-IHO-VM670-"+theDate);
						buttonTextView.setText("Download Now");
					} else {
						textView.setText("Current: "+BUILD_DATE+"\n\nAvailable: "+theDate+"\n\nCheck again later");
						buttonTextView.setText("Already Up To Date");
					}
				} else {
				    Intent downloadUpdate = new Intent(Intent.ACTION_VIEW);
				    downloadUpdate.setData(Uri.parse(theUrl));
				    startActivity(downloadUpdate);
					textView.setText("Reboot into recovery,\nWipe cache & dalvik\nThen flash the zip file");
					theButton.setVisibility(1);
				}
			}

			catch (Exception e) {
				System.out.println("Nay, did not work");
				textView.setText(e.getMessage());
				}
			break;
			}
		}
	}